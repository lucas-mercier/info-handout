<!DOCTYPE html>
<html  lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-145664552-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-145664552-1');
    </script>
    
      <title>12Les fichiers</title>
    
      <link rel="stylesheet" href="../_static/pygments.css">
      <link rel="stylesheet" href="../_static/theme.css">
      
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

      <!-- sphinx script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>

      
      <script src="../_static/theme-vendors.js"></script>
      <script src="../_static/theme.js" defer></script>
    
    <link rel="icon" href="../_static/favicon.ico" type="image/x-icon" />
  <link rel="index" title="Index" href="../genindex.html" />
  <link rel="search" title="Recherche" href="../search.html" />
  <link rel="next" title="13Gestion de la mémoire" href="55-memory-management.html" />
  <link rel="prev" title="11Types composites" href="45-compound-datatype.html" /> 
  </head>

  <body>
    <div id="app" class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="../index.html" class="home-link">
    
      <span class="site-name">Le C pour l&#39;ingenieur</span>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">

  
    <div class="nav-item">
      <a href="../index.html#le-c-pour-l-ingenieur"
         class="nav-link  router-link-active">
         Contenu
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../index.html#le-c-pour-l-ingenieur"
         class="nav-link ">
         Annexes
      </a>
    </div>
  



    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            

  
    <div class="nav-item">
      <a href="../index.html#le-c-pour-l-ingenieur"
         class="nav-link  router-link-active">
         Contenu
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../index.html#le-c-pour-l-ingenieur"
         class="nav-link ">
         Annexes
      </a>
    </div>
  



            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">Recherche rapide</span>
    <div class="searchformwrapper">
      <form class="search" action="../search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="Recherche" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../index.html#le-c-pour-l-ingenieur">Contenu</a></span>
      </p>
      <ul class="current">
        
          <li class="toctree-l1 "><a href="05-introduction.html" class="reference internal ">Introduction</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="07-programming.html" class="reference internal ">La programmation</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="10-foundations.html" class="reference internal ">Généralités du langage</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="15-numeration.html" class="reference internal ">Numération</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="17-operators.html" class="reference internal ">Opérateurs</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="20-datatype.html" class="reference internal ">Types de données</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="25-control-structures.html" class="reference internal ">Structures de contrôle</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="30-processus.html" class="reference internal ">Programmes et Processus</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="35-stdio.html" class="reference internal ">Entrées Sorties</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="40-functions.html" class="reference internal ">Fonctions</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="45-compound-datatype.html" class="reference internal ">Types composites</a>

            
          </li>

        
          <li class="toctree-l1 current"><a href="#" class="reference internal current">Les fichiers</a>

            
              <ul>
                
                  <li class="toctree-l2"><a href="#systeme-de-fichiers" class="reference internal">Système de fichiers</a></li>
                
                  <li class="toctree-l2"><a href="#format-d-un-fichier" class="reference internal">Format d'un fichier</a></li>
                
                  <li class="toctree-l2"><a href="#ouverture-d-un-fichier" class="reference internal">Ouverture d'un fichier</a></li>
                
                  <li class="toctree-l2"><a href="#navigation-dans-un-fichier" class="reference internal">Navigation dans un fichier</a></li>
                
                  <li class="toctree-l2"><a href="#lecture-ecriture" class="reference internal">Lecture / Écriture</a></li>
                
                  <li class="toctree-l2"><a href="#buffer-de-fichier" class="reference internal">Buffer de fichier</a></li>
                
              </ul>
            
          </li>

        
          <li class="toctree-l1 "><a href="55-memory-management.html" class="reference internal ">Gestion de la mémoire</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="60-pointers.html" class="reference internal ">Pointeurs</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="70-standard-library.html" class="reference internal ">Bibliothèques</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="75-preprocessor.html" class="reference internal ">Préprocesseur</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="77-algorithms.html" class="reference internal ">Algorithmes et conception</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="78-translation-units.html" class="reference internal ">Assemblage différé</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="80-scopes.html" class="reference internal ">Portée et visibilité</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="82-testing.html" class="reference internal ">Qualité et Testabilité</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="85-linked-list.html" class="reference internal ">Structures récursives</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="90-advanced-topics.html" class="reference internal ">Avancé</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="92-traps.html" class="reference internal ">Pièges</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="95-philosophy.html" class="reference internal ">Philosophie</a>

            
          </li>

        
      </ul>
    </div>
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../index.html#le-c-pour-l-ingenieur">Annexes</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 "><a href="../appendix/10-vscode.html" class="reference internal ">Visual Studio Code</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="../appendix/20-grammar.html" class="reference internal ">Grammaire C</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="../appendix/30-doxygen.html" class="reference internal ">Documentation automatique avec Doxygen</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="../appendix/40-development.html" class="reference internal ">Environnement de développement</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="../appendix/70-unit.html" class="reference internal ">Fiches d'unités</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="../appendix/80-laboratories.html" class="reference internal ">Laboratoires</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="../appendix/88-summary.html" class="reference internal ">Résumé</a>

            
          </li>

        
          <li class="toctree-l1 "><a href="../appendix/99-colophon.html" class="reference internal ">Colophon</a>

            
          </li>

        
      </ul>
    </div>
  
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
    
    <li><span class="section-number">12</span>Les fichiers</li>
  </ul>
  

  <ul class="page-nav">
  <li class="prev">
    <a href="45-compound-datatype.html"
       title="Chapitre précédent">← <span class="section-number">11</span>Types composites</a>
  </li>
  <li class="next">
    <a href="55-memory-management.html"
       title="Chapitre suivant"><span class="section-number">13</span>Gestion de la mémoire →</a>
  </li>
</ul>
  
</div>
<hr>
          <div class="content" role="main">
            
  <div class="section" id="les-fichiers">
<h1><span class="section-number">12</span>Les fichiers<a class="headerlink" href="#les-fichiers" title="Lien permanent vers ce titre">¶</a></h1>
<div class="section" id="systeme-de-fichiers">
<h2><span class="section-number">12.1</span>Système de fichiers<a class="headerlink" href="#systeme-de-fichiers" title="Lien permanent vers ce titre">¶</a></h2>
<p>Dans un environnement POSIX tout est fichier. <code class="docutils literal notranslate"><span class="pre">stdin</span></code> est un fichier, une souris USB est un fichier, un clavier est un fichier, un terminal est un fichier, un programme est un fichier.</p>
<p>Les fichiers sont organisés dans une arborescence gérée par un <a class="reference external" href="https://fr.wikipedia.org/wiki/Syst%C3%A8me_de_fichiers">système de fichiers</a>. Sous Windows l'arborescence classique est:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">C:</span>
<span class="go">├── Program Files         Programmes installés</span>
<span class="go">├── Users                 Comptes utilisateur</span>
<span class="go">│   └── John</span>
<span class="go">│       ├── Desktop</span>
<span class="go">│       ├── Documents</span>
<span class="go">│       └── Music</span>
<span class="go">└── Windows</span>
<span class="go">    ├── Fonts             Polices de caractères</span>
<span class="go">    ├── System32          Système d&#39;exploitation 64-bits (oui, oui)</span>
<span class="go">    └── Temp              Fichiers temporaires</span>
</pre></div>
</div>
<p>Il y a une arborescence par disque physique <code class="docutils literal notranslate"><span class="pre">C:</span></code>, <code class="docutils literal notranslate"><span class="pre">D:</span></code>, une arborescence par chemin réseau <code class="docutils literal notranslate"><span class="pre">\\eistore2</span></code>, etc. Sous POSIX, la stratégie est différente, car il n'existe qu'UN SEUL système de fichier dont la racine est <code class="docutils literal notranslate"><span class="pre">/</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">/</span>
<span class="go">├── bin                   Programmes exécutables cruciaux</span>
<span class="go">├── dev                   Périphériques (clavier, souris, ...)</span>
<span class="go">├── usr</span>
<span class="go">│   └── bin               Programmes installés</span>
<span class="go">├── mnt                   Points de montage (disques réseaux, CD, clé USB)</span>
<span class="go">│   └── eistore2</span>
<span class="go">├── tmp                   Fichiers temporaires</span>
<span class="go">├── home                  Comptes utilisateurs</span>
<span class="go">│   └── john</span>
<span class="go">│       └── documents</span>
<span class="go">└── var                   Fichiers variables comme les logs ou les database</span>
</pre></div>
</div>
<p>Chaque élément qui contient d'autres éléments est appelé un <strong>répertoire</strong> ou <strong>dossier</strong>, en anglais <em>directory</em>. Chaque répertoire contient toujours au minimum deux fichiers spéciaux:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">.</span></code></dt><dd><p>Un fichier qui symbolise le répertoire courant, celui dans lequel je me trouve</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">..</span></code></dt><dd><p>Un fichier qui symbolise le répertoire parent, c'est à dire <code class="docutils literal notranslate"><span class="pre">home</span></code> lorsque je suis dans <code class="docutils literal notranslate"><span class="pre">john</span></code>.</p>
</dd>
</dl>
<p>La localisation d'un fichier au sein d'un système de fichier peut être soit <strong>absolue</strong> soit <strong>relative</strong>. Cette localisation s'appelle un <strong>chemin</strong> ou <em>path</em>. La convention est d'utiliser le symbole:</p>
<ul class="simple">
<li><p>Slash <code class="docutils literal notranslate"><span class="pre">/</span></code> sous POSIX</p></li>
<li><p>Antislash <code class="docutils literal notranslate"><span class="pre">\</span></code> sous Windows</p></li>
</ul>
<p>Le chemin <code class="docutils literal notranslate"><span class="pre">/usr/bin/.././bin/../../home/john/documents</span></code> est correct mais il n'est pas <a class="reference external" href="https://fr.wikipedia.org/wiki/Canonique_(math%C3%A9matiques)">canonique</a>. La forme canonique est <code class="docutils literal notranslate"><span class="pre">/home/john/documents</span></code>. Un chemin peut être relatif s'il ne commence pas par un <code class="docutils literal notranslate"><span class="pre">/</span></code>: <code class="docutils literal notranslate"><span class="pre">../bin</span></code>. Sous Windows c'est pareil mais la racine différemment selon le type de média <code class="docutils literal notranslate"><span class="pre">C:\</span></code>, <code class="docutils literal notranslate"><span class="pre">\\network</span></code>, ...</p>
<p>Lorsqu'un programme s'exécute, son contexte d'exécution est toujours par rapport à son emplacement dans le système de fichier donc le chemin peut être soit relatif, soit absolu.</p>
</div>
<div class="section" id="format-d-un-fichier">
<h2><span class="section-number">12.2</span>Format d'un fichier<a class="headerlink" href="#format-d-un-fichier" title="Lien permanent vers ce titre">¶</a></h2>
<p>Un fichier peut avoir un contenu arbitraire; une suite de zéros et de uns binaire. Selon l'interprétation, un fichier pourrait contenir une image, un texte ou un programme. Le cas particulier ou le contenu est lisible par un éditeur de texte, on appelle ce fichier un <a class="reference external" href="https://fr.wikipedia.org/wiki/Fichier_texte">fichier texte</a>. C'est-à-dire que chaque caractère est encodé sur 8-bit et que la table ASCII est utilisée pour traduire le contenu en un texte intelligible. Lorsque le contenu n'est pas du texte, on l'appelle un <a class="reference external" href="https://fr.wikipedia.org/wiki/Fichier_binaire">fichier binaire</a>.</p>
<p>La frontière est parfois assez mince, car parfois le fichier binaire peut contenir du texte intelligible, la preuve avec ce programme:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">password</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;un mot de passe secret&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">password</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Si nous le compilons et cherchons dans son code binaire:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gcc example.c
$ hexdump -C a.out | grep -C3 sec
000006f0  f3 c3 00 00 48 83 ec 08  48 83 c4 08 c3 00 00 00  |....H...H.......|
00000700  01 00 02 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000710  75 6e 20 6d 6f 74 20 64  65 20 70 61 73 73 65 20  |un mot de passe |
00000720  73 65 63 72 65 74 00 00  01 1b 03 3b 3c 00 00 00  |secret.....;&lt;...|
00000730  06 00 00 00 e8 fd ff ff  88 00 00 00 08 fe ff ff  |................|
00000740  b0 00 00 00 18 fe ff ff  58 00 00 00 22 ff ff ff  |........X...&quot;...|
00000750  c8 00 00 00 58 ff ff ff  e8 00 00 00 c8 ff ff ff  |....X...........|
</pre></div>
</div>
<p>Sous un système POSIX, il n'existe aucune distinction formelle entre un fichier binaire et un fichier texte. En revanche sous Windows il existe une subtile différence concernant surtout le caractère de fin de ligne. La commande <code class="docutils literal notranslate"><span class="pre">copy</span> <span class="pre">a.txt</span> <span class="pre">+</span> <span class="pre">b.txt</span> <span class="pre">c.txt</span></code> considère des fichiers textes et ajoutera automatiquement une fin de ligne entre chaque partie concaténée, mais celle-ci <code class="docutils literal notranslate"><span class="pre">copy</span> <span class="pre">/b</span> <span class="pre">a.bin</span> <span class="pre">+</span> <span class="pre">b.bin</span> <span class="pre">c.bin</span></code> ne le fera pas.</p>
</div>
<div class="section" id="ouverture-d-un-fichier">
<h2><span class="section-number">12.3</span>Ouverture d'un fichier<a class="headerlink" href="#ouverture-d-un-fichier" title="Lien permanent vers ce titre">¶</a></h2>
<p>Sous POSIX, un programme doit demander au système d'exploitation l'accès à un fichier soit en lecture, soit en écriture soit les deux. Le système d'exploitation retourne un descripteur de fichier qui est simplement un entier unique pour le programme.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;toto&quot;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
    <span class="n">getchar</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Lorsque le programme ci-dessus est exécuté, il va demander l'ouverture du fichier <code class="docutils literal notranslate"><span class="pre">toto</span></code> en lecture et recevoir un descripteur de fichier <code class="docutils literal notranslate"><span class="pre">fd</span></code> (<em>file descriptor</em>) positif en cas de succès ou négatif en cas d'erreur.</p>
<p>Dans l'exemple suivant, on compile, puis exécute en arrière-plan le programme qui ne se terminera pas puisqu'il attend un caractère d'entrée. L'appel au programme <code class="docutils literal notranslate"><span class="pre">ps</span></code> permet de lister la liste des processus en cours et la recherche de <code class="docutils literal notranslate"><span class="pre">test</span></code> permet de noter le numéro du processus, ici <code class="docutils literal notranslate"><span class="pre">6690</span></code>. Dans l'arborescence de fichiers, il est possible d'aller consulter les descripteurs de fichiers ouverts pour le processus concerné.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> gcc test.c -o <span class="nb">test</span> <span class="o">&amp;&amp;</span> ./test <span class="p">&amp;</span>
<span class="gp">$</span> ps -u <span class="p">|</span> grep <span class="nb">test</span>
<span class="go">ycr       6690  0.0  0.0  10540   556 pts/4    T    11:19   0:00 test</span>
<span class="gp">$</span> ls /proc/6690/fd
<span class="go">0  1  2  3</span>
</pre></div>
</div>
<p>On observe que trois descripteurs de fichiers sont ouverts.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">0</span></code> pour <code class="docutils literal notranslate"><span class="pre">STDIN</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">1</span></code> pour <code class="docutils literal notranslate"><span class="pre">STDOUT</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">2</span></code> pour <code class="docutils literal notranslate"><span class="pre">STDERR</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">3</span></code> pour le fichier <code class="docutils literal notranslate"><span class="pre">toto</span></code> ouvert en lecture seule</p></li>
</ul>
<p>La fonction <code class="docutils literal notranslate"><span class="pre">open</span></code> est en réalité un appel système qui n'est standardisé que sous POSIX, c'est-à-dire que son utilisation n'est pas portable. L'exemple cité est principalement évoqué pour mieux comprendre le mécanisme de fond pour l'accès aux fichiers.</p>
<p>En réalité la bibliothèque standard, respectueuse de C99, dispose d'une fonction <code class="docutils literal notranslate"><span class="pre">fopen</span></code> pour <em>file open</em> qui offre plus de fonctionnalités. Ouvrir un fichier se résume donc à</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&quot;toto&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// Error the file cannot be accessed</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Le mode d'ouverture du fichier peut être:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">r</span></code></dt><dd><p>Ouverture en lecture seule depuis le début du fichier.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">r+</span></code></dt><dd><p>Ouverture pour lecture et écriture depuis le début du fichier.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">w</span></code></dt><dd><p>Ouverture en écriture. Le fichier est créé s'il n'existe pas déjà, sinon le contenu est effacé. Le pointeur de fichier est positionné au début de ce dernier.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">w+</span></code></dt><dd><p>Ouverture en écriture et lecture. Le fichier est créé s'il n'existe pas déjà. Le pointeur de fichier est positionné au début de ce dernier.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">a</span></code></dt><dd><p>Ouverture du fichier pour insertion. Le fichier est créé s'il n'existe pas déjà. Le pointeur est positionné à la fin du fichier.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">a+</span></code></dt><dd><p>Ouverture du fichier pour lecture et écriture. Le fichier est créé s'il n'existe pas déjà et le pointeur du fichier est positionné à la fin.</p>
</dd>
</dl>
<p>Sous Windows et pour soucis de compatibilité, selon la norme C99, le flag <code class="docutils literal notranslate"><span class="pre">b</span></code> pour <em>binary</em> existe. Pour ouvrir un fichier en mode binaire on peut alors écrire <code class="docutils literal notranslate"><span class="pre">rb+</span></code>.</p>
<p>L'ouverture d'un fichier cause, selon le mode, un accès exclusif au fichier. C'est-à-dire que d'autres programmes ne pourront pas accéder à ce fichier. Il est donc essentiel de toujours refermer l'accès à un fichier dès lors que l'opération de lecture ou d'écriture est terminée:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">flose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</pre></div>
</div>
<p>On peut noter que sous POSIX, écrire sur <code class="docutils literal notranslate"><span class="pre">stdout</span></code> ou <code class="docutils literal notranslate"><span class="pre">stderr</span></code> est exactement la même chose qu'écrire sur un fichier, il n'y a aucune distinction.</p>
</div>
<div class="section" id="navigation-dans-un-fichier">
<h2><span class="section-number">12.4</span>Navigation dans un fichier<a class="headerlink" href="#navigation-dans-un-fichier" title="Lien permanent vers ce titre">¶</a></h2>
<p>Lorsqu'un fichier est ouvert, un curseur virtuel est positionné soit au début soit à la fin du fichier. Lorsque des données sont lues ou écrites, c'est à la position de ce curseur, lequel peut être déplacé en utilisant plusieurs fonctions utilitaires.</p>
<p>La navigation dans un fichier n'est possible que si le fichier est <em>seekable</em>. Généralement les pointeurs de fichiers <code class="docutils literal notranslate"><span class="pre">stdout</span></code> et <code class="docutils literal notranslate"><span class="pre">stderr</span></code> ne sont pas <em>seekable</em>, et il n'est pas possible de se déplacer dans le fichier mais seulement écrire dedans.</p>
<div class="section" id="fseek">
<h3><span class="section-number">12.4.1</span>fseek<a class="headerlink" href="#fseek" title="Lien permanent vers ce titre">¶</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">fseek</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">whence</span><span class="p">)</span>
</pre></div>
</div>
<p>Le manuel <a class="reference external" href="http://man7.org/linux/man-pages/man3/fseek.3.html">man fseek</a> indique les trois constantes possibles pour <code class="docutils literal notranslate"><span class="pre">whence</span></code>:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">SEEK_SET</span></code></dt><dd><p>Positionne le curseur au début du fichier.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">SEEK_CUR</span></code></dt><dd><p>Position courante du curseur. Permets d'ajouter un offset relatif à la position courante.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">SEEK_END</span></code></dt><dd><p>Positionne le curseur à la fin du fichier.</p>
</dd>
</dl>
</div>
<div class="section" id="ftell">
<h3><span class="section-number">12.4.2</span>ftell<a class="headerlink" href="#ftell" title="Lien permanent vers ce titre">¶</a></h3>
<p>Il est parfois utile de savoir où se trouve le curseur. <code class="docutils literal notranslate"><span class="pre">ftell()</span></code> retourne la position actuelle du curseur dans un fichier ouvert.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">char</span> <span class="n">filename</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;foo&quot;</span><span class="p">;</span>

<span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="sc">&#39;r&#39;</span><span class="p">);</span>
<span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_END</span><span class="p">);</span>
<span class="kt">long</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">();</span>

<span class="n">printf</span><span class="p">(</span><span class="s">&quot;The file %s has a size of %ld Bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="rewind">
<h3><span class="section-number">12.4.3</span>rewind<a class="headerlink" href="#rewind" title="Lien permanent vers ce titre">¶</a></h3>
<p>L'appel <code class="docutils literal notranslate"><span class="pre">rewind()</span></code> est équivalent à <code class="docutils literal notranslate"><span class="pre">(void)</span> <span class="pre">fseek(stream,</span> <span class="pre">0L,</span> <span class="pre">SEEK_SET)</span></code> et permet de se positionner au début du fichier.</p>
</div>
</div>
<div class="section" id="lecture-ecriture">
<h2><span class="section-number">12.5</span>Lecture / Écriture<a class="headerlink" href="#lecture-ecriture" title="Lien permanent vers ce titre">¶</a></h2>
<p>La lecture, écriture dans un fichier s'effectue de manière analogue aux fonctions que nous avons déjà vues <code class="docutils literal notranslate"><span class="pre">printf</span></code> et <code class="docutils literal notranslate"><span class="pre">scanf</span></code> pour les flux standards (<em>stdout</em>, <em>stderr</em>), mais en utilisant les pendants fichiers:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">fscanf(FILE</span> <span class="pre">*stream,</span> <span class="pre">const</span> <span class="pre">char</span> <span class="pre">*format,</span> <span class="pre">...)</span></code></dt><dd><p>Équivalent à <code class="docutils literal notranslate"><span class="pre">scanf</span></code> mais pour les fichiers</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">fprintf(FILE</span> <span class="pre">*stream,</span> <span class="pre">const</span> <span class="pre">char</span> <span class="pre">*format,</span> <span class="pre">...)</span></code></dt><dd><p>Équivalent à <code class="docutils literal notranslate"><span class="pre">printf</span></code> mais pour les fichiers</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">fgetc(FILE</span> <span class="pre">*stream)</span></code></dt><dd><p>Équivalent à <code class="docutils literal notranslate"><span class="pre">getchar</span></code> (ISO/IEC 9899 §7.19.7.6-2)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">fputc(FILE</span> <span class="pre">*stream,</span> <span class="pre">char</span> <span class="pre">char)</span></code></dt><dd><p>Équivalent à <code class="docutils literal notranslate"><span class="pre">putchar</span></code> (ISO/IEC 9899 §7.19.7.9-2)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">*fgets(char</span> <span class="pre">*</span> <span class="pre">restrict</span> <span class="pre">s,</span> <span class="pre">int</span> <span class="pre">n,</span> <span class="pre">FILE</span> <span class="pre">*</span> <span class="pre">restrict</span> <span class="pre">stream)</span></code></dt><dd><p>Équivalent à <code class="docutils literal notranslate"><span class="pre">gets</span></code></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">fputs(const</span> <span class="pre">char</span> <span class="pre">*</span> <span class="pre">restrict</span> <span class="pre">s,</span> <span class="pre">FILE</span> <span class="pre">*</span> <span class="pre">restrict</span> <span class="pre">stream)</span></code></dt><dd><p>Équivalent à <code class="docutils literal notranslate"><span class="pre">puts</span></code></p>
</dd>
</dl>
<p>Bref... Vous avez compris.</p>
<p>Les nouvelles fonctions à connaître sont les suivantes:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">fread(void</span> <span class="pre">*ptr,</span> <span class="pre">size_t</span> <span class="pre">size,</span> <span class="pre">size_t</span> <span class="pre">nmemb,</span> <span class="pre">FILE</span> <span class="pre">*stream)</span></code></dt><dd><p>Lecture arbitraire de <code class="docutils literal notranslate"><span class="pre">nmemb</span> <span class="pre">*</span> <span class="pre">size</span></code> bytes depuis le flux <code class="docutils literal notranslate"><span class="pre">stream</span></code> dans le buffer <code class="docutils literal notranslate"><span class="pre">ptr</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int32_t</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="n">fread</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int32_t</span><span class="p">),</span> <span class="n">stdin</span><span class="p">);</span>

<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%x</span><span class="se">\n</span><span class="s">%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">echo</span> -e <span class="s2">&quot;0123abcdefgh&quot;</span> <span class="p">|</span> ./a.out
<span class="go">33323130</span>
<span class="go">64636261</span>
</pre></div>
</div>
<p>On notera au passage la nature <em>little-endian</em> du système.</p>
</dd>
</dl>
<p><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">fwrite(const</span> <span class="pre">void</span> <span class="pre">*ptr,</span> <span class="pre">size_t</span> <span class="pre">size,</span> <span class="pre">size_t</span> <span class="pre">nmemb,</span> <span class="pre">FILE</span> <span class="pre">*stream)</span></code></p>
<blockquote>
<div><p>La fonction est similaire à <code class="docutils literal notranslate"><span class="pre">fread</span></code> mais pour écrire sur un flux.</p>
</div></blockquote>
</div>
<div class="section" id="buffer-de-fichier">
<h2><span class="section-number">12.6</span>Buffer de fichier<a class="headerlink" href="#buffer-de-fichier" title="Lien permanent vers ce titre">¶</a></h2>
<p>Pour améliorer les performances, C99 prévoit (§7.19.3-3), un espace tampon pour les descripteurs de fichiers qui peuvent être:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">unbuffered</span></code> (<code class="docutils literal notranslate"><span class="pre">_IONBF</span></code>)</dt><dd><p>Pas de buffer, les caractères lus ou écrits sont acheminés le plus vite possible de la source à la destination.</p>
</dd>
</dl>
<p><code class="docutils literal notranslate"><span class="pre">fully</span> <span class="pre">buffered</span></code> (<code class="docutils literal notranslate"><span class="pre">_IOFBF</span></code>)</p>
<p><code class="docutils literal notranslate"><span class="pre">line</span> <span class="pre">buffered</span></code> (<code class="docutils literal notranslate"><span class="pre">_IO_LBF</span></code>)</p>
<p>Il faut comprendre qu'à chaque instant un programme souhaite écrire dans un fichier, il doit générer un appel système et donc interrompre le noyau. Un programme qui écrirait caractère par caractère sur la sortie standard agirait de la même manière qu'un employé des postes qui irait distribuer son courrier en ne prenant qu'une enveloppe à la fois, de la centrale de distribution au destinataire.</p>
<p>Par défaut, un pointeur de fichier est <em>fully buffered</em>. C'est-à-dire que dans le cas du programme suivant devrait exécuter 10x l'appel système <code class="docutils literal notranslate"><span class="pre">write</span></code>, une fois par caractère.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;--no-buffering&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;c&#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Cependant le comportement réel est différent. Seulement si le buffer est désactivé que le programme interrompt le noyau pour chaque caractère:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> gcc buftest.c -o buftest

<span class="gp">$</span> strace ./buftest <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> grep write
<span class="go">write(1, &quot;cccccccccc&quot;, 10cccccccccc)              = 10</span>

<span class="gp">$</span> strace ./buftest --no-buffering <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> grep write
<span class="go">write(1, &quot;c&quot;, 1c)                        = 1</span>
<span class="go">write(1, &quot;c&quot;, 1c)                        = 1</span>
<span class="go">write(1, &quot;c&quot;, 1c)                        = 1</span>
<span class="go">write(1, &quot;c&quot;, 1c)                        = 1</span>
<span class="go">write(1, &quot;c&quot;, 1c)                        = 1</span>
<span class="go">write(1, &quot;c&quot;, 1c)                        = 1</span>
<span class="go">write(1, &quot;c&quot;, 1c)                        = 1</span>
<span class="go">write(1, &quot;c&quot;, 1c)                        = 1</span>
<span class="go">write(1, &quot;c&quot;, 1c)                        = 1</span>
<span class="go">write(1, &quot;c&quot;, 1c)                        = 1</span>
</pre></div>
</div>
<p>Le changement de mode peut être effectué avec la fonction <code class="docutils literal notranslate"><span class="pre">setbuf</span></code> ou <code class="docutils literal notranslate"><span class="pre">setvbuf</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>

    <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

    <span class="n">fputs</span><span class="p">(</span><span class="s">&quot;Allo ?&quot;</span><span class="p">);</span>

    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>La fonction <code class="docutils literal notranslate"><span class="pre">fflush</span></code> force l'écriture malgré l'utilisation d'un buffer.</p>
<hr class="docutils" />
<p><a class="reference external" href="../exercises.html#exercise/12/1">Exercice 12.1</a>: Variantes</p>
<p><a class="reference external" href="../exercises.html#exercise/12/2">Exercice 12.2</a>: Numéro de ligne</p>
</div>
</div>


          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
  <li class="prev">
    <a href="45-compound-datatype.html"
       title="Chapitre précédent">← <span class="section-number">11</span>Types composites</a>
  </li>
  <li class="next">
    <a href="55-memory-management.html"
       title="Chapitre suivant"><span class="section-number">13</span>Gestion de la mémoire →</a>
  </li>
</ul><div class="footer" role="contentinfo">
      &#169; Copyright HEIG-VD(c) 2019.
    Mis à jour le 01 nov. 2019 (version 0.2.0-2-g5c41ba3).
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.1 with <a href="https://github.com/heig-vd-tin/sphinx_heigvd_theme">HEIG-VD Theme</a>.
</div>
            </div>
          </div>
      </page>
    </div>
    
    
  </body>
</html>